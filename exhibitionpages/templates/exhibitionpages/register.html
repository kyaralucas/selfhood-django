{% extends "exhibitionpages/base.html" %}
{% load static %}
{% block title %}Register{% endblock %}

{% block content %}
<section class="reg-page">

  <!-- Top row -->
  <div class="reg-top">
    <div class="reg-kicker">SELFHOOD ACT II</div>

    <div class="reg-top-center">
      <img class="reg-mini-svg reg-mini-svg--ora" src="{% static 'svg/ora_mi_black.svg' %}" alt="Ora mi">
      <div class="reg-kicker reg-kicker--center">EXHIBITION BY AQUEENE WILSON</div>
      <img class="reg-mini-svg reg-mini-svg--topa" src="{% static 'svg/topa_mi_mes_black.svg' %}" alt="topa mi mes">
    </div>

    <div class="reg-kicker">20 FEB-5 APRIL</div>
  </div>

  <!-- Title + meta -->
  <div class="reg-hero">
    <h1 class="reg-title">EXHIBITION OPENING</h1>

    <div class="reg-meta">
      <div class="reg-meta__date">20 FEBRUARY 2026 · 19:00 - 21:00</div>
      <div class="reg-meta__loc"><em>NOS SENTRO · ST. ROSAWEG 13 · WILLEMSTAD, CURAÇAO</em></div>
    </div>

    <div class="reg-note">
      Registration is free. Limited capacity per timeslot to keep <br> the experience soft and unrushed.
    </div>
  </div>

  <!-- Tabs-ish labels -->
  <div class="reg-tabs">
    <div class="reg-tab">
        <span class="reg-dot"></span>
        <span class="reg-tab__label">details</span>
      </div>
      
      <div class="reg-tab">
        <span class="reg-dot"></span>
        <span class="reg-tab__label">timeslot</span>
      </div>
      
  </div>

  <!-- Main card -->
  <div class="reg-card">


    <form method="post" class="reg-form" id="regForm" novalidate>
        {% csrf_token %}
      
        <!-- Step indicators (optional, ties to your dots) -->
        <input type="hidden" id="regStep" name="reg_step" value="1" />
      
        <!-- STEP 1: DETAILS -->
        <div class="reg-step" id="stepDetails" data-step="1">
          <div class="reg-section">
            <div class="reg-field">
              <label class="reg-label">Name</label>
              {{ form.name }}
            </div>
      
            <div class="reg-field">
              <label class="reg-label">Email</label>
              {{ form.email }}
            </div>
          </div>

          <br>
          <div class="reg-field">
            <label class="reg-label">Guests</label>
            {{ form.guests }}
            <div class="reg-hint">If your group is more than 2, please register separately.</div>
          </div>          
      
          <div class="reg-section">
            <div class="reg-subtitle"></div>
      
            <div class="reg-prompt">
              <div class="reg-prompt__q"></div>
              <input type="hidden" name="asked_question" value="{{ asked_question|escape }}">
              <label class="reg-label">(OPTIONAL) {{ asked_question }} (<span id="answerCount">0</span>/1000)</label>
              <!-- <div class="reg-hint">
                
            </div> -->
              <!-- <label class="reg-label">{{ form.prompt_answer.label }}</label> -->
              {{ form.prompt_answer }}
              <!-- <div class="reg-hint">You can leave this blank.</div> -->
            </div>
            
            {% if form.errors.prompt_answer %}
            <div class="reg-error">{{ form.errors.prompt_answer }}</div>
            {% endif %}

          </div>
      
          <button class="btn reg-submit" id="nextBtn" type="button">Next</button>
        </div>
      
        <!-- STEP 2: TIMESLOT -->
        <div class="reg-step" id="stepSlot" data-step="2" hidden>
          <div class="reg-section">
            <div class="reg-subtitle">Choose a time slot</div>
      
            {% if form.errors.slot %}
              <div class="reg-error">{{ form.errors.slot }}</div>
            {% endif %}
      
            <div class="reg-slots">
              {% for slot in slots %}
                {% with is_full=slot.is_full %}
                <label class="reg-slot {% if is_full %}reg-slot--disabled{% endif %}">
                  <input
                    class="reg-slot__input"
                    type="radio"
                    name="slot"
                    value="{{ slot.id }}"
                    {% if is_full %}disabled{% endif %}
                    {% if form.data.slot == slot.id|stringformat:"s" %}checked{% endif %}
                  />
                  <span class="reg-slot__time">{{ slot.time }}</span>
                  <span class="reg-slot__meta">{% if is_full %}Full{% endif %}</span>
                </label>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
      
          <div class="reg-actions">
            <button class="btn reg-submit reg-submit--ghost" id="backBtn" type="button">Back</button>
          
            <button class="btn reg-submit" id="registerBtn" type="submit">
              <span class="btn-label">Register</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </div>
          
        </div>
      </form>

      <div id="processingOverlay" class="processing-overlay" hidden>
        <br>
        <div class="processing-box" role="status" aria-live="polite">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div class="reg-note">Processing your registration…</div>
        </div>
      </div>
      
      

  </div>

</section>

<script>




      (function () {
    const form = document.getElementById("regForm");
    const overlay = document.getElementById("processingOverlay");
    if (!form || !overlay) return;

    function showOverlay() {
      overlay.hidden = false;
      // prevent accidental double-clicks while waiting
      const buttons = form.querySelectorAll('button, input[type="submit"]');
      buttons.forEach(b => b.disabled = true);
    }

    function hideOverlay() {
      overlay.hidden = true;
      const buttons = form.querySelectorAll('button, input[type="submit"]');
      buttons.forEach(b => b.disabled = false);
    }

    // Intercept the actual submit button click so we can repaint first
    form.addEventListener("click", function (e) {
      const submitBtn = e.target.closest('button[type="submit"], input[type="submit"]');
      if (!submitBtn) return;

      // If HTML5 validation fails, don't show overlay
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Stop immediate navigation; show overlay; submit next frame
      e.preventDefault();
      showOverlay();

      requestAnimationFrame(() => {
        form.submit(); // programmatic submit
      });
    });

    // If user goes back and browser restores the page from cache, reset UI
    window.addEventListener("pageshow", function (e) {
      if (e.persisted) hideOverlay();
    });
  })();


    const ta = document.querySelector('textarea[name="prompt_answer"]');
  const out = document.getElementById('answerCount');

  if (ta && out) {
    const update = () => out.textContent = ta.value.length;
    ta.addEventListener('input', update);
    update();
  }

    const stepDetails = document.getElementById("stepDetails");
    const stepSlot = document.getElementById("stepSlot");
    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const stepInput = document.getElementById("regStep");
  
    // These IDs are usually "id_name" / "id_email" for Django forms
    const nameInput = document.getElementById("id_name");
    const emailInput = document.getElementById("id_email");
  
    function showStep(n){
      if (n === 1){
        stepDetails.hidden = false;
        stepSlot.hidden = true;
        stepInput.value = "1";
        // optional: scroll to top of card
        stepDetails.scrollIntoView({behavior:"smooth", block:"start"});
      } else {
        stepDetails.hidden = true;
        stepSlot.hidden = false;
        stepInput.value = "2";
        stepSlot.scrollIntoView({behavior:"smooth", block:"start"});
      }
  
      // update the dots (if you want)
      document.querySelectorAll(".reg-tab").forEach((el, idx) => {
        el.classList.toggle("is-active", (idx + 1) === n);
      });
    }
  
    const guestsInput = document.getElementById("id_guests");

    function isStrictEmail(email) {
    // simple “must have @ and a dot in the domain” rule
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email.trim());
    }




    function basicValidateDetails() {
  const nameOk = nameInput && nameInput.value.trim().length > 0;

  const emailVal = (emailInput && emailInput.value || "").trim();
  const emailOk = emailVal.length > 0 && isStrictEmail(emailVal);

  const guestsOk = !guestsInput || guestsInput.value === "1" || guestsInput.value === "2";
  return nameOk && emailOk && guestsOk;
}

    nextBtn.addEventListener("click", () => {
    if (!nameInput.value.trim()) {
        alert("Please fill in your name first.");
        nameInput.focus();
        return;
    }

    const emailVal = emailInput.value.trim();
    if (!emailVal) {
        alert("Please fill in your email first.");
        emailInput.focus();
        return;
    }

    if (!isStrictEmail(emailVal)) {
        alert("Please enter a valid email address (example: name@example.com).");
        emailInput.focus();
        return;
    }

    showStep(2);
    });

  
    backBtn.addEventListener("click", () => showStep(1));
  
    // If the server returned slot errors OR user had already selected a slot,
    // jump to step 2 on page load.
    const hasSlotError = document.querySelector(".reg-error") !== null;
    const hasSlotSelected = document.querySelector('input[name="slot"]:checked') !== null;
  
    if (hasSlotError || hasSlotSelected){
      showStep(2);
    } else {
      showStep(1);
    }
  </script>
  
{% endblock %}
